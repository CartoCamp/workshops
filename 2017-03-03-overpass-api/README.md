# OpenStreetMap Overpass API

OpenStreetMap's [Overpass API](http://wiki.openstreetmap.org/wiki/Overpass_API) is a "read-only API that serves up custom selected parts of the OSM map data." This CartoCamp workshop is an introduction to the query language of Overpass and how you can use it to obtain points, lines, and shapes for your maps.

## Requirements
There are no installation requirements for this workshop, but if you would like to incorporate API results into a map right away, you should get a free CARTO account. Signup for an account here: <https://carto.com/signup>

## Overpass Turbo
[Overpass Turbo](http://overpass-turbo.eu/) is a "web-based data filtering tool" with a built-in wizard that makes constructing simple queries less of a headache. It also allows you to preview the data before downloading or exporting. If you want to start making more advanced queries, it's recommended to use Overpass Turbo to help you experiment and get familiar with the query language structure.

### Let's Unpack a Simple Overpass Turbo Query

In the Overpass Turbo Wizard, type the following query and select "build":

```
tourism=museum in "New York"
```

Let's take a look at the query that Overpass Turbo just built:

```
/*
This has been generated by the overpass-turbo wizard.
The original search was:
“tourism=museum in "New York"”
*/
[out:json][timeout:25];
// fetch area “New York” to search in
{{geocodeArea:New York}}->.searchArea;
// gather results
(
  // query part for: “tourism=museum”
  node["tourism"="museum"](area.searchArea);
  way["tourism"="museum"](area.searchArea);
  relation["tourism"="museum"](area.searchArea);
);
// print results
out body;
>;
out skel qt;
```
Elements of this query (we'll go over each in detail):

1. Settings for the output format and timeout
2. An area for the search is defined with `geocodeArea`
3. The query for a key-value pair `tourism=museum` tag on _nodes, ways_, and _relations_.
4. Results are printed into a `body` and `skel qt`

Some other things to note about the query:

- The query is a string of statements, each statement ending with a semicolon. The statements are processed one after another.
- Statements can be:
	- Standalone queries: These are complete statements on their own.
	- Filters: They are always part of a query statement and contain the interesting selectors and filters.
	- Block statements: They group statements and enable disjunctions as well as loops.
	- Settings: Things like output format and timeout that can be set once at the beginning.

Check out what the data returned looks like in Map-view and Data-view.

## Export the data
Remove the settings for json and timeout at the beginning of the New York museum query and [re-run](http://overpass-turbo.eu/s/mUa).

Select Export --> Data --> Copy link for "raw data directly from Overpass API"

Go to your CARTO account, make a new dataset or map. Select "Connect Dataset" and paste in the URL you copied.

After the import has finished, view your new map! Notice that only points appear... what happened to the polygons?

It looks like there are 53 points and 57 polygons of museums found in NYC. CARTO can't have two type of geometries in the same dataset. _Maybe I should change this first example to only look for points... Later we can figure out how to find the centroid of those polygons!_

## Museums in multiple cities

Let's make use of block statements to create a union of search areas. In this query, we're looking for museum locations in both Boston and New York. Nothing else has changed about the query.

```
[out:json][timeout:25];
({{geocodeArea:New York}};{{geocodeArea:Boston}})->.searchArea;
(
  node["tourism"="museum"](area.searchArea);
  way["tourism"="museum"](area.searchArea);
  relation["tourism"="museum"](area.searchArea);
);
out body;
>;
out skel qt;
```

## Why this is awesome!

- Try searching Google for "museum locations Boston and New York shapefile" ... this data doesn't exist ready for consumption.
- [Official NYC Museums Locations](
https://data.cityofnewyork.us/Recreation/New-York-City-Museums/ekax-ky3z) from NYC Open Data
- Boston doesn't appear to have a museum shapefile readily available at the moment
- You would still need to join the layers together and do custom filtering to get the same results.

## Why this might not be as awesome...

- OSM is like the Wikipedia of human location knowledge. Anyone can add or edit the data. The source needs to be double-checked. Information might be wrong or missing!
- Overpass query language can be difficult to work with.

## Search for playgrounds around schools
You can also chain queries to get output satisfying a second criterion that are located around nodes matching the first criterion. In this example, we find parks within 100m of schools in NYC:

```
/*
Find parks within 100m of schools in NYC
*/
[out:json];
{{geocodeArea:New York}}->.searchArea;
  node[amenity='school'](area.searchArea);
(node
  (around:100)
  [leisure="park"];
way
  (around:100)
  [leisure="park"]);
out body;
>;
out skel qt;
```

## Lingering questions (TO DO)
- What the heck is "recursion"?
- What are "sets"?
- What kind of tags can I search for?
- What is a node, way, and relation?
- How can I check the source?
- CARTO can't handle multiple geometry types! What do I do?
- Tons of [examples](http://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_API_by_Example)
- What OSM tags can I query? <https://taginfo.openstreetmap.org>